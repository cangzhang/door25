FROM debian:trixie-slim

ARG TARGETARCH

WORKDIR /usr/app

COPY assets assets
COPY config config

# Copy target directory structure (both binaries are in context, but we'll select the correct one)
COPY target/ target/

# Select and copy the correct binary based on target architecture
# TARGETARCH is automatically set by Docker Buildx: amd64 or arm64
RUN if [ "$TARGETARCH" = "amd64" ]; then \
      BINARY_PATH="target/x86_64-unknown-linux-gnu/release/door25-cli"; \
    elif [ "$TARGETARCH" = "arm64" ]; then \
      BINARY_PATH="target/aarch64-unknown-linux-gnu/release/door25-cli"; \
    else \
      echo "Unsupported architecture: $TARGETARCH" && exit 1; \
    fi && \
    if [ ! -f "$BINARY_PATH" ]; then \
      echo "Error: Binary not found at $BINARY_PATH for architecture $TARGETARCH" && \
      echo "Available binaries:" && \
      find target/ -name "door25-cli" -type f 2>/dev/null || true && \
      exit 1; \
    fi && \
    cp "$BINARY_PATH" door25-cli && \
    chmod +x door25-cli && \
    rm -rf target

ENTRYPOINT ["/usr/app/door25-cli"]
